{% load static humanize %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEYSA TEKNİK | İhale Detay – {{ ihale.ihale_no }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --ekap-blue: #1a5695; --ekap-green: #28a745; --bg-gray: #f4f7fa; --text-primary: #2d2d2d; --border-mid: #e0e0e0; }
        body { background-color: var(--bg-gray); font-family: 'Source Sans 3', system-ui, sans-serif; color: var(--text-primary); }
        .ekap-navbar { padding: 15px 40px; background: white; border-bottom: 1px solid var(--border-mid); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .nav-capsule { background: #f8f9fa; border-radius: 50px; padding: 6px 20px; border: 1px solid var(--border-mid); display: flex; gap: 14px; align-items: center; }
        .nav-capsule a { text-decoration: none; color: var(--text-primary); font-size: 13px; font-weight: 500; white-space: nowrap; }
        .nav-capsule a:hover { color: var(--ekap-blue); }
        .nav-user-block { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 8px 14px; border-radius: 50px; border: 1px solid #e9ecef; }
        .nav-user-block .nav-username { font-size: 13px; font-weight: 600; color: var(--ekap-blue); text-transform: uppercase; letter-spacing: 0.3px; }
        .nav-user-block .btn-logout { font-size: 12px; padding: 5px 12px; border-radius: 20px; font-weight: 600; }
        .nav-upload-btn { background: var(--ekap-blue); color: white !important; padding: 6px 15px; border-radius: 20px; font-weight: 700; box-shadow: 0 2px 8px rgba(26, 86, 149, 0.3); }
        .nav-upload-btn:hover { background: #144477; color: white; }
        .detay-kart { background: white; border-radius: 12px; border: 1px solid #e0e6ed; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .detay-baslik { font-size: 11px; text-transform: uppercase; color: #6c757d; margin-bottom: 4px; }
        .detay-deger { font-size: 1rem; font-weight: 600; color: #212529; }
        .kalem-satir:hover { background-color: #f8f9fa; }
        .kalem-gecmis-link { font-size: 12px; }
        .teklif-panel { position: fixed; top: 0; right: 0; width: 320px; max-width: 100%; height: 100%; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.1); z-index: 1050; transition: transform 0.3s ease; transform: translateX(100%); overflow-y: auto; }
        .teklif-panel.acik { transform: translateX(0); }
        .teklif-panel .panel-icerik { padding: 20px; }
        .teklif-panel .kapat { position: absolute; top: 12px; right: 12px; }
    </style>
</head>
<body>

<nav class="ekap-navbar">
    <a href="{% url 'ana_sayfa' %}"><img src="{% static 'img/meysa_logo.jpeg' %}" style="height: 55px;"></a>
    <div class="nav-capsule">
        <a href="{% url 'ana_sayfa' %}">Anasayfa</a>
        <a href="{% url 'ihale_listesi' %}">İhaleler</a>
        <a href="{% url 'dogrudan_temin_listesi' %}">Doğrudan Teminler</a>
        <a href="{% url 'dosya_yukleme' %}" class="nav-upload-btn"><i class="fas fa-cloud-upload-alt me-1"></i> Dosya Yükleme</a>
        <a href="{% url 'arabalar' %}">Arabalar</a>
        <div style="width:1px; height:20px; background:#ddd;"></div>
        <a href="{% url 'analiz' %}">Analiz</a>
        <a href="{% url 'mesailerim' %}">Mesailerim</a>
        <a href="{% url 'profilim' %}" style="color: #28a745; font-weight: 700;">Profilim</a>
        <a href="{% url 'iletisim' %}">İletişim <i class="fas fa-phone-alt ms-1"></i></a>
    </div>
    <div class="d-flex align-items-center gap-2">
        <div class="nav-user-block">
            <span class="nav-username">{{ user.username }}</span>
            <form action="/admin/logout/" method="post" style="display:inline; margin:0;">{% csrf_token %}<button type="submit" class="btn btn-sm btn-outline-danger btn-logout">Çıkış</button></form>
        </div>
        <a href="/ihale/{{ ihale.pk }}/excel-indir/" class="btn btn-sm btn-success"><i class="fas fa-file-excel me-1"></i> Excel Çıktı Al</a>
        {% if ihale.is_dogrudan_temin %}<a href="{% url 'dogrudan_temin_listesi' %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-arrow-left me-1"></i> Listeye Dön</a>{% else %}<a href="{% url 'ihale_listesi' %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-arrow-left me-1"></i> Listeye Dön</a>{% endif %}
    </div>
</nav>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            {% if ihale.is_dogrudan_temin %}
            <span class="badge bg-success me-2"><i class="fas {% if ihale.tur == 'Hizmet' %}fa-tools{% elif ihale.tur == 'Yapım' %}fa-hard-hat{% else %}fa-box{% endif %} me-1"></i>{{ ihale.tur|default:"Mal" }}</span>
            {% else %}
            <span class="badge bg-primary me-2"><i class="fas {% if ihale.tur == 'Hizmet' %}fa-tools{% elif ihale.tur == 'Yapım' %}fa-hard-hat{% else %}fa-box{% endif %} me-1"></i>{{ ihale.get_tur_display|default:ihale.tur }}</span>
            {% endif %}
            {{ ihale.ihale_adi }}
        </h4>
        <span class="badge bg-secondary">{{ ihale.get_durum_display|default:ihale.durum }}</span>
    </div>

    <div class="detay-kart">
        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>Dosya Bilgileri</h6>
        <div class="row g-3">
            <div class="col-md-3"><div class="detay-baslik">İhale / İKN No</div><div class="detay-deger">{{ ihale.ihale_no }}</div></div>
            <div class="col-md-3"><div class="detay-baslik">Tarih</div><div class="detay-deger">{{ ihale.tarih|date:"d.m.Y" }}</div></div>
            <div class="col-md-3"><div class="detay-baslik">Hastane / Kurum</div><div class="detay-deger">{{ ihale.hastane.ad }}</div></div>
            <div class="col-md-3"><div class="detay-baslik">İl / İlçe</div><div class="detay-deger">{{ ihale.il }}{% if ihale.ilce %} / {{ ihale.ilce }}{% endif %}</div></div>
            <div class="col-md-4"><div class="detay-baslik">Toplam Teklif Bedeli (₺)</div><div class="detay-deger">{{ ihale.toplam_teklif_bedeli|floatformat:2 }}</div></div>
            <div class="col-md-4"><div class="detay-baslik">Bizim Teklif (₺)</div><div class="detay-deger">{{ ihale.bizim_teklif|floatformat:2|default:"—" }}</div></div>
            <div class="col-md-4"><div class="detay-baslik">Kazanan Firma / Fiyat</div><div class="detay-deger">{% if ihale.kazanan_firma %}{{ ihale.kazanan_firma }} – {{ ihale.kazanan_fiyat|floatformat:2 }} ₺{% else %}—{% endif %}</div></div>
        </div>
        <div class="mt-3 pt-3 border-top d-flex flex-wrap align-items-center gap-2">
            {% if ihale.cetvel_dosya %}<a href="{{ ihale.cetvel_dosya.url }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-file-excel me-1"></i>Cetvel</a>{% endif %}
            {% if ihale.sartname_dosya %}<a href="{{ ihale.sartname_dosya.url }}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="fas fa-file-pdf me-1"></i>Şartname</a>{% endif %}
            {% if ihale.verilen_teklif_dosya %}
                <a href="{{ ihale.verilen_teklif_dosya.url }}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-file-signature me-1"></i>Verilen Teklif</a>
            {% else %}
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('teklifPanel').classList.add('acik');"><i class="fas fa-file-signature me-1"></i>Verilen Teklif (Yükle)</button>
            {% endif %}
        </div>
        <div id="teklifPanel" class="teklif-panel">
            <button type="button" class="btn btn-sm btn-outline-secondary kapat" onclick="this.closest('.teklif-panel').classList.remove('acik');" aria-label="Kapat"><i class="fas fa-times"></i></button>
            <div class="panel-icerik mt-4">
                <h6 class="fw-bold mb-3"><i class="fas fa-file-signature me-1"></i> Verilen Teklif (ıslak imzalı) Yükle</h6>
                <form action="{% url 'ihale_verilen_teklif_yukle' ihale.pk %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" name="verilen_teklif_dosya" class="form-control form-control-sm mb-2" accept=".pdf,.jpg,.jpeg,.png">
                    <button type="submit" class="btn btn-primary btn-sm w-100">Yükle</button>
                </form>
            </div>
        </div>
        <div class="mt-2 small text-muted">
            Yükleyen: <b>{{ ihale.olusturan_kullanici.username|default:"Sistem" }}</b> · Son işlem: {{ ihale.guncellenme_tarihi|date:"d.m.Y H:i" }}
        </div>
    </div>

    <div class="detay-kart">
        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-list me-2"></i>Kalemler</h6>
        <p class="small text-muted mb-3">Birim fiyat girin ve Fiyatları Kaydet ile toplam güncellenir. Kalem adı veya Geçmiş ile ürün geçmişine gidebilirsiniz.</p>
        <form action="{% url 'toplu_fiyat_guncelle' %}" method="POST" id="fiyat-form-detay">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-sm table-hover table-bordered kalem-tablo">
                    <thead class="table-light">
                        <tr>
                            <th>Ürün Adı</th>
                            <th class="text-center" style="width:80px;">Miktar</th>
                            <th class="text-center" style="width:80px;">Birim</th>
                            <th class="text-center" style="width:120px;">Birim Fiyat (₺)</th>
                            <th class="text-center" style="width:120px;">Toplam (₺)</th>
                            <th class="text-center">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for kalem in ihale.kalemler.all %}
                        <tr class="kalem-satir" data-adet="{{ kalem.adet }}">
                            <td>
                                <div class="d-flex align-items-center justify-content-between gap-2">
                                    <a href="/kalem/{{ kalem.pk }}/gecmis/" class="text-dark text-decoration-none fw-bold">{{ kalem.urun_adi }}</a>
                                    <span class="d-flex gap-1">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" title="Görsel" data-bs-toggle="modal" data-bs-target="#gorselModal-{{ kalem.id }}"><i class="fas fa-image"></i></button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" title="Şartname" onclick="var e=document.getElementById('sartname-{{ kalem.id }}'); e.style.display=e.style.display==='block'?'none':'block';"><i class="fas fa-file-alt"></i></button>
                                    </span>
                                </div>
                                <div id="sartname-{{ kalem.id }}" class="small text-muted mt-2 border-start border-2 border-secondary ps-2" style="display:none;">{% if kalem.teknik_sartname_ozeti %}{{ kalem.teknik_sartname_ozeti }}{% else %}—{% endif %}</div>
                            </td>
                            <td class="text-center align-middle">{{ kalem.adet|floatformat:0 }}</td>
                            <td class="text-center align-middle">{{ kalem.birim }}</td>
                            <td class="text-center align-middle">
                                <input type="hidden" name="kalem_id[]" value="{{ kalem.id }}">
                                <input type="text" name="fiyat[]" class="form-control form-control-sm kalem-birim-fiyat text-end" value="{{ kalem.birim_fiyat|floatformat:2 }}" placeholder="0.00" inputmode="decimal">
                            </td>
                            <td class="text-center align-middle fw-bold kalem-toplam-cell">{{ kalem.toplam_fiyat|floatformat:2 }}</td>
                            <td class="text-center align-middle">
                                <a href="/kalem/{{ kalem.pk }}/gecmis/" class="btn btn-sm btn-outline-primary"><i class="fas fa-history me-1"></i>Geçmiş</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center py-4 text-muted">Henüz kalem eklenmemiş. Aşağıdan ekleyebilirsiniz.</td></tr>
                        {% endfor %}
                    </tbody>
                    {% if ihale.kalemler.all %}
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Toplam Tutar</td>
                            <td class="text-center fw-bold toplam-tutar-cell">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
            {% if ihale.kalemler.all %}
            <div class="mt-2"><button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-check-circle me-1"></i> Fiyatları Kaydet</button></div>
            {% endif %}
        </form>
        {% for kalem in ihale.kalemler.all %}
        <div class="modal fade" id="gorselModal-{{ kalem.id }}" tabindex="-1">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header py-2"><h6 class="modal-title">Görsel: {{ kalem.urun_adi|truncatewords:4 }}</h6><button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body py-3">
                        {% if kalem.kalem_gorsel %}<p class="mb-2"><img src="{{ kalem.kalem_gorsel.url }}" alt="" class="img-fluid rounded"></p>{% endif %}
                        <form action="{% url 'kalem_gorsel_yukle' kalem.pk %}" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="file" name="kalem_gorsel" class="form-control form-control-sm" accept="image/*">
                            <button type="submit" class="btn btn-sm btn-primary mt-2 w-100">Yükle</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <hr class="my-4" id="kalem-ekle">
        <h6 class="fw-bold mb-2"><i class="fas fa-plus-circle me-1"></i> Kalem Ekle</h6>
        <form action="{% url 'kalem_ekle' ihale.pk %}" method="POST" class="row g-2 align-items-end">
            {% csrf_token %}
            <div class="col-md-4"><input type="text" name="urun_adi" class="form-control form-control-sm" placeholder="Ürün adı" required></div>
            <div class="col-1"><input type="text" name="adet" class="form-control form-control-sm" placeholder="Miktar" value="1"></div>
            <div class="col-1"><input type="text" name="birim" class="form-control form-control-sm" placeholder="Birim" value="Adet"></div>
            <div class="col-2"><input type="text" name="birim_fiyat" class="form-control form-control-sm" placeholder="Birim fiyat (₺)" value="0"></div>
            <div class="col-2"><input type="text" name="toplam_fiyat" class="form-control form-control-sm" placeholder="Toplam (₺)" value="0"></div>
            <div class="col-2"><button type="submit" class="btn btn-sm btn-primary w-100"><i class="fas fa-plus me-1"></i> Ekle</button></div>
        </form>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    if (window.location.hash === "#kalem-ekle") {
        var el = document.getElementById("kalem-ekle");
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    function parseNum(v){ return Math.max(0, parseFloat(String(v).replace(",","."))||0); }
    function guncelleSatir(satir){
        var adet = parseNum(satir.getAttribute("data-adet"));
        var inp = satir.querySelector(".kalem-birim-fiyat");
        var cell = satir.querySelector(".kalem-toplam-cell");
        if(!inp||!cell) return;
        var top = adet * parseNum(inp.value);
        cell.textContent = top.toFixed(2);
        var tfoot = satir.closest("table")&&satir.closest("table").querySelector("tfoot");
        if(tfoot){
            var tbody = satir.closest("tbody");
            var genel = 0;
            tbody.querySelectorAll(".kalem-satir").forEach(function(r){
                var a = parseNum(r.getAttribute("data-adet"));
                var i = r.querySelector(".kalem-birim-fiyat");
                genel += a * (i ? parseNum(i.value) : 0);
            });
            var tc = tfoot.querySelector(".toplam-tutar-cell");
            if(tc) tc.textContent = genel.toFixed(2);
        }
    }
    document.querySelectorAll(".kalem-birim-fiyat").forEach(function(inp){
        inp.addEventListener("focus", function(){ this.setSelectionRange(0, 0); });
        inp.addEventListener("input", function(){ guncelleSatir(inp.closest(".kalem-satir")); });
        inp.addEventListener("change", function(){ guncelleSatir(inp.closest(".kalem-satir")); });
    });
    document.querySelectorAll(".kalem-tablo tbody .kalem-satir").forEach(function(satir){ guncelleSatir(satir); });
})();
</script>
</body>
</html>
